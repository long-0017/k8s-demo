# 在k8s中部署redis

## 部署应用

- 使用临时目录存放redis数据
- 暴露redis的端口6379

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: redis-deployment
spec:
  replicas: 1
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:6.2
        ports:
        - containerPort: 6379
        volumeMounts:
        - name: redis-data
          mountPath: /data
      volumes:
      - name: redis-data
        emptyDir: {}   
```

## 暴露服务

使用NodePort方式暴露redis服务，绑定到节点的6379端口，可以通过节点IP:6379的方式访问到redis服务。

```yaml
apiVersion: v1
kind: Service
metadata:
  name: redis-service
spec:
  type: NodePort
  selector:
    app: redis
  ports:
    - protocol: TCP
      port: 6379
      targetPort: 6379
      nodePort: 6379
```

正式部署：
```bash
kubectl apply -f redis-deployment.yaml
```

## 在应用中连接redis

引入redis相关依赖

```xml
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-starter-data-redis</artifactId>
        </dependency>
```

在配置文件application.properties中增加redis配置
```properties
# Redis
spring.redis.host=${REDIS_HOST:redis-service}
spring.redis.port=${REDIS_PORT:6379}
```

通过环境变量的方式加载redis的连接信息
在部署文件中，将环境变量REDIS_HOST设置为redis-service，环境变量REDIS_PORT设置为6379
